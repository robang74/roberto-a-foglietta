<!DOCTYPE html>
<html>
    <head>
        <title>305-thinkpad-x390-thunderbolt-netac-usbstick</title>
        <meta charset='UTF-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <link rel='shortcut icon' type='image/x-icon' href='favicon.ico?'>
        <link rel='stylesheet' href='default.css'>
        <link rel='stylesheet' href='../intl/intlflg.css'>
        <!-- here begins the Javascript... why for the hell I got here? //-->
        <meta http-equiv='Content-Script-Type' content='text/javascript'>
        <link rel='stylesheet' href='ucustom.css' id='customStylesheet' media='screen'>
        <script>const cssdir='';</script note='global variable'>
        <script src='css-style-changer.js' defer></script>
        <link rel='stylesheet' href='printer.css' media='print'>
    </head>
    <body>
<style>#printlink { display: inline; } @page { size: legal; margin: 0.50in 13.88mm 0.50in 13.88mm; zoom: 100%; } @media print { html { zoom: 100%; } }</style>
<p class='topbar'></p>
<div class='topbar' width='800px' translate='no'><b id='menu' onClick='nextStylesheet()'>&thinsp;&#9783;&thinsp;&Ropf;</b> &thinsp;&mdash;&thinsp; &#8543;&#8239;release: <b class='topbar'>2025-03-01&nbsp;<sup class='date-type topbar' id='datenote'>(&hairsp;<a href='#date-legenda' class='date-type topbar'>1</a>&hairsp;)</sup></b>  &thinsp;&mdash;&thinsp; rev.: <b class='topbar
'>7</b rev_num='
'> &thinsp;&mdash;&thinsp; transl.:&nbsp; <a class='topbar' href='https://robang74-github-io.translate.goog/roberto-a-foglietta/html/305-thinkpad-x390-thunderbolt-netac-usbstick?_x_tr_sl=en&_x_tr_tl=it&_x_tr_hl=it-IT&_x_tr_pto=wapp' target='_blank' rel='noopener noreferrer'>IT</a> &nbsp;<b>&middot;</b>&nbsp; <a class='topbar' href='https://robang74-github-io.translate.goog/roberto-a-foglietta/html/305-thinkpad-x390-thunderbolt-netac-usbstick?_x_tr_sl=en&_x_tr_tl=de&_x_tr_hl=de-DE&_x_tr_pto=wapp' target='_blank' rel='noopener noreferrer'>DE</a> &nbsp;<b>&middot;</b>&nbsp; <a class='topbar' href='https://robang74-github-io.translate.goog/roberto-a-foglietta/html/305-thinkpad-x390-thunderbolt-netac-usbstick?_x_tr_sl=en&_x_tr_tl=fr&_x_tr_hl=fr-FR&_x_tr_pto=wapp' target='_blank' rel='noopener noreferrer'>FR</a> &nbsp;<b>&middot;</b>&nbsp; <a class='topbar' href='https://robang74-github-io.translate.goog/roberto-a-foglietta/html/305-thinkpad-x390-thunderbolt-netac-usbstick?_x_tr_sl=en&_x_tr_tl=es&_x_tr_hl=es-ES&_x_tr_pto=wapp' target='_blank' rel='noopener noreferrer'>ES</a> &thinsp;&mdash;&thinsp; goto:&nbsp; <a class='topbar' href='../index.html#index'>.&#x27F0;.</a> &nbsp;<b>&middot;</b>&nbsp; <a class='topbar' href='../../chatbots-for-fun/index.html'target=_blank>C4F</a> &nbsp;<b>&middot;</b>&nbsp; <a class='topbar' href='../../chatgpt-answered-prompts/index.html'target=_blank>Q&A</a> <span id='printlink'>&thinsp;&mdash;&thinsp; <b>⎙</b>&hairsp;: <a aria-label='print this page' class='topbar' href='javascript:window.print()'>PDF</a></span>&nbsp;</div>
<div id="firstdiv">
<p class='topbar'></p>
<div align="center"><img class="bwsketch" src="../img/305-thinkpad-x390-thunderbolt-netac-usbstick-img-001.png" width="800"><br></div>
<p></p>
<H2 id="thinkpad-x390-bios-usb-c-full-bandwidth">ThinkPad X390 BIOS USB-C full bandwidth</H2>
<p></p>
Published initially on LinkedIn and on <a href="https://www.facebook.com/plugins/post.php?href=https%3A%2F%2Fwww.facebook.com%2Froberto.a.foglietta%2Fposts%2Fpfbid0e8pbVkLx9L9XbmX1VCoFqRM1M5JTEVv4WufrHFQQPnX8d49had1FxQSyQ3qc3Posl" target='_blank' rel='noopener noreferrer'>Facebook</a> on 1st March 2025, then updated and collected here.
<p></p>
<hr>
<p></p>
I have noticed a drastic drop in performance on my X390 USB-C Thunderbolt port when I have enabled that system in full and in particular the option which is marked with a green circle. I do not want to convince anyone that disabling that option can 2x increase the performance on that port. Just give it a try, and judge by yourself on Ubuntu 22.04 with 6.08 kernel and Netac US9 512GB as USB 3.2 drive.
<p></p>
This is the Grok3 explanation about my experience and it is totally coherent with what I have seen on my own and in my case. Which confirms my feeling that it is better keep the Thunderbolt disabled as long as it is not used (changing that settings requires 15s for the BIOS and a reboot).
<p></p>
<div class="post-it"><b class="post-it">&#9432;</b>
<p></p>
<H4>Why It Affects USB Performance</H4>
<p></p>
Your Netac US9 is a USB 3.2 drive (likely Gen 2, 10 Gbps), not a Thunderbolt device, but it’s using the X390’s USB-C Thunderbolt 3 port. Here’s how enabling pre-boot Thunderbolt activation could throttle it.
<p></p>
<H4>Prioritization of Thunderbolt Protocol</H4>
<p></p>
When enabled, the BIOS might configure the Thunderbolt controller to assume a Thunderbolt device is attached, prioritizing PCIe tunneling or Thunderbolt signaling over USB SuperSpeed. USB-C ports multiplex USB and Thunderbolt over the same pins/lanes. If Thunderbolt gets precedence, the USB SuperSpeed pairs (SSRX/SSRX+ and SSTX/SSTX+) might not negotiate at their full potential, capping the port at USB 3.0 (5 Gbps) instead of USB 3.2 Gen 2 (10 Gbps).
<p></p>
<H4> Lane Misconfiguration</H4>
<p></p>
Thunderbolt 3 uses up to 4 PCIe lanes, dynamically allocated with USB and DisplayPort. Pre-boot activation might reserve or misalign these lanes, leaving fewer or slower paths for USB data. Your 300-500 MB/s matches USB 3.0’s real-world limit (400-500 MB/s with overhead), suggesting it’s stuck at 5 Gbps instead of 10 Gbps (800-1000 MB/s in real-world).
<p></p>
<H4> Latency or Overhead</H4>
<p></p>
Enabling pre-boot Thunderbolt could introduce controller polling or initialization delays, adding latency to USB transfers. This might not drop the theoretical speed but could reduce effective throughput, especially on a non-Thunderbolt device like your Netac.
<p></p>
<H4> Negotiation Downgrade:</H4>
<p></p>
The kernel (xhci_hcd) relies on the hardware’s initial state. If the BIOS hands over a port pre-configured for Thunderbolt, USB 3.2 negotiation might fail or downgrade to USB 3.0 (Gen 1), as seen in your ~300-500 MB/s range.
<p></p>
</div>
<p></p>
<hr>
<p></p>
<H3 id="thunderbolt-firmware-upgrade">Thunderbolt firmware upgrade</H3>
<p></p>
After Ubuntu proposed to me the Thunderbolt firmware upgrade 20.00 &rarr; 23.00, and I accepted it, I did not manage to go above 560Mb/s while - before the upgrade - I hit the 900MB/s and a little above. Check in the comments the screenshot about the firmware upgrade.
<p></p>
While moving on lowlatency kernel, the system did something better but still did not see the top v20.00 Thunderbolt Firmware performance.
<p></p>
<li><tt>268435456 bytes (268 MB, 256 MiB) copied, 0.314098 s, 855 MB/s</tt></li>
<p></p>
Plus adding this into Linux kernel command line:
<p></p>
<li><tt>usbcore.autosuspend=-1</tt></li>
<p></p>
which is fine in AC mode but it would be better to have "1" on battery to save power, the max speed achieved is near the nominal value of the usbkey:
<p></p>
<li><tt>268435456 bytes (268 MB, 256 MiB) copied, 0.279603 s, 960 MB/s</tt></li>
<p></p>
Which is not bad at all, but it requires a deeper investigation. Therefore, here below a bash script to check the average data transfer speed.
<p></p>
<blockquote class="code"><code>
&num; variables<br>
f=/tmp/usbkey.tst<br>
d=/dev/sda<br>
n=10
<p></p>
&num; test 10 or 100 tries<br>
umount $d&ast; 2>/dev/null; for i in $(seq $n); do<br>
dd if=$d bs=1M count=256 skip=$[RANDOM%256] of=/dev/null 2>&1 |\<br>
 &nbsp; grep bytes; done | tee $f<br>
<p></p>
&num; maths<br>
str=$(cat $f | cut -d, -f4 | sort -n)<br>
min=$(echo "$str" | head -n1); max=$(echo "$str" | tail -n1)<br>
let sum=$(sed -ne "s/.&ast; s, \([0-9]&ast;\) .&ast;/\\1+/p" $f | tr -d '\n')0<br>
if [ $sum -eq 0 ]; then<br>
let sum=$(sed -ne "s/.&ast; s, \([0-9.,]&ast;\) .&ast;/\\1+/p" $f | tr -d '\n',.)0<br>
let n*=10; fi; avg=$[sum/n].$[sum%n]<br>
<p></p>
&num; results<br>
printf "\n min:%s, avg: %s MB/s, max:%s \n\n" "$min" $avg "$max"<br>
</code></blockquote>
<p></p>
<div class="pagebreak"><br></div>
<p></p>
<H4>Results print out & comments</H4>
<p></p>
Because the direct access to the device is not cached
<p></p>
<li><tt>min: 194 MB/s, avg: 838.45 MB/s, max: 960 MB/s</tt> with <tt>usbcore.autosuspend=-1</tt></li>
<li><tt>min: 407 MB/s, avg: 856.91 MB/s, max: 963 MB/s</tt> with <tt>intel_iommu=on iommu=pt</tt></li>
<p></p>
the average data transfer speed is looking quite impressive!
<p></p>
Anyway, here we are testing the USB data speed transfer.
<p></p>
The use of a real USB stick like Netac US9 is just for bragging... <img class='emoji wbsketch' src='../img/emoji/grin.png'>
<p></p>
<hr>
<p></p>
<H3 id="thinkpad-x390-tweaks">ThinkPad X390 tweaks</H3>
<p></p>
All the changes presented here requires the <tt>root</tt> permission.
<p></p>
<H4>1. snpd warning in dmesg</H4>
<p></p>
In case you Linux kernel <tt>dmeg</tt> log reports a problem with <tt>snapd</tt> configuration you can apply this change:
<p></p>
<blockquote class="code"><code>
&num; with systemd v254+, skip going through failed state during restart<br>
&num;RestartMode=direct<br>
&num;Restart=always<br>
Restart=on-failure<br>
RestartSec=5s<br>
</code></blockquote>
<p></p>
<p></p>
<H4>2. i915 granted in initramfs</H4>
<p></p>
This is optional and might create troubles, apply only if necessary:
<p></p>
<blockquote class="code"><code>
echo "<br>
drm_kms_helper<br>
drm_fb_helper<br>
i915" >> /etc/initramfs-tools/modules<br>
echo blacklist elan_i2c >> /etc/modprobe.d/blacklist.conf<br>
echo blacklist thunderbolt >> /etc/modprobe.d/blacklist.conf<br>
update-initramfs -u # -k all # only after giving a test<br>
</code></blockquote>
<p></p>
Having a 2nd kernel for testing and boot the system when the 1st fails, it is a good habit.
<p></p>
<H4>3. non-US keyboard mapping</H4>
<p></p>
<blockquote class="code"><code>
kbd.map=it # choose your keyboard layout<br>
update-grub
</code></blockquote>
<p></p>
<H4>4. avoid logo shown at boot</H4>
<p></p>
<blockquote class="code"><code>
bgrt_disable=1<br>
update-grub
</code></blockquote>
<p></p>
<div class="pagebreak"><br></div>
<p></p>
<H2 id="an-useful-usb-c-hub">An useful USB-C hub</H2>
<p></p>
Ask me why I am so happy with little gadget...
<p></p>
<div class='center'>
<img src="../img/305-thinkpad-x390-thunderbolt-netac-usbstick-img-002.jpg" width="400">
<br>
<sup>right click menu to (2x) enlarge the image</sup>
</div>
<p></p>
I will tell you what I do not like about it - the HDMI - is a duplication for my Thinkpad X390 or X280 and I wish I had found the version with a USB-C port, instead. Cheaper and more useful for me. However, I understand that a lot of people out there that have not yet joined the Cult (of having a Thinkpad as their laptop) desperately need a HDMI port and this adapter provides it to them.
<p></p>
The 2x USB 3.0 ports are valuable but they seem to work at 5 Gbits each. If they can sustain that speed simultaneously, then it starts to be reasonable.
<p></p>
<li><tt>min: 276 MB/s, avg: 424.29 MB/s, max: 445 MB/s</tt></li>
<p></p>
Again, for most people this is enough. For those who have an X390 or X280 this little guy can charge the laptop while functioning as a hub therefore a USB 3.2 at 10Gbits became available. Moreover, few devices can really fully leverage 10Gbits data transfer.
<p></p>
Having a SD and MMC reader, especially because both are functional at the same time, is something nice to have. Especially for those who are still using dedicated digital photo cameras. I paid €4.99 for such a reader, alone. So the two main reasons I bought this USB hub is because:
<p></p>
<li class='numli'><b>1.&emsp;</b>it uses the PD 3.0 10Gbits UBS-C port for powering the laptop, leaving the other one free;</li>
<li class='numli'><b>2.&emsp;</b>it provides a Ethernet 1Gbits RJ45 and 2x USB 3.0 5Gbits ports, a SD/MMC cards reader.</li>
<p></p>
And it is a real gigabits network which are another five bucks but takes away a USB port:
<p></p>
<li><tt>dd if=/dev/zero bs=1500 count=16M | nc -N 10.10.10.2 1111</tt></li>
<li><tt>25165824000 bytes (25 GB, 23 GiB) copied, 213.972 s, 118 MB/s</tt></li>
<p></p>
Please, keep in consideration that Ubuntu 22.04 on the Esprimo P910 is running with a whole CPU core dedicated to the kernel and IRQ management while the X390 is using a low-latency kernel and both are leveraging Intel IOMMU passthrough.
<p></p>
Last but not least, it costs €8.15 on Temu and it is sent within Europe using the Amazon 2-days delivery service (islands, apart) at the extra price of €2.99.
<p></p>
<br>
<p></p>
<H2 id="share-alike">Share alike</H2>
<p></p>
<p>&copy; 2025, <b>Roberto A. Foglietta</b> &lt;roberto.foglietta<span>&commat;</span>gmail.com&gt;, <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target='_blank' rel='noopener noreferrer'>CC BY-NC-ND 4.0</a></p>
<p></p>
</div>
<p></p>
<div id='date-legenda' align='center' translate='no'><sub><hr></sub><sub><b>date legenda</b>: &#x2776; first draft publishing date or &#x2777; creation date in git, otherwise &#x2778; html creation page date. <u>&mapstoup;<a href='#' class='toplink' translate='no'>top</a>&mapstoup;</u></sub></div>
<br class='pagebreak'>
    </body>
</html>
